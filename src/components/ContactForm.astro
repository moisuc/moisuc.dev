---
interface Props {
  t: {
    title: string;
    name: string;
    namePlaceholder: string;
    email: string;
    emailPlaceholder: string;
    message: string;
    messagePlaceholder: string;
    send: string;
    sending: string;
    success: string;
    error: string;
  };
}

const { t } = Astro.props;

// Get keys from environment variables
const web3formsKey = import.meta.env.PUBLIC_WEB3FORMS_KEY;
const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
---

<div class="w-full max-w-md mx-auto">
  <h3 class="font-display font-bold text-2xl mb-6 text-center">{t.title}</h3>
  
  <form 
    id="contact-form"
    action="https://api.web3forms.com/submit" 
    method="POST"
    class="space-y-4"
  >
    <!-- Web3Forms Access Key from environment variable -->
    <input type="hidden" name="access_key" value={web3formsKey} />
    
    <!-- Email to receive submissions -->
    <input type="hidden" name="to_email" value="moisuc.catalin@gmail.com" />
    
    <!-- Form subject -->
    <input type="hidden" name="subject" value="New message from moisuc.dev" />
    
    <!-- Redirect after submission -->
    <input type="hidden" name="redirect" value="https://moisuc.dev?success=true" />
    
    <!-- Honeypot spam protection -->
    <input type="checkbox" name="botcheck" class="hidden" style="display: none;" />
    
    <!-- Name -->
    <div>
      <label for="name" class="block text-sm font-medium text-zinc-300 mb-2">
        {t.name}
      </label>
      <input 
        type="text" 
        id="name" 
        name="name" 
        required
        placeholder={t.namePlaceholder}
        class="w-full px-4 py-3 bg-surface-light border border-border rounded-lg text-white placeholder-muted focus:outline-none focus:border-accent/50 focus:ring-1 focus:ring-accent/50 transition-all"
      />
    </div>
    
    <!-- Email -->
    <div>
      <label for="email" class="block text-sm font-medium text-zinc-300 mb-2">
        {t.email}
      </label>
      <input 
        type="email" 
        id="email" 
        name="email" 
        required
        placeholder={t.emailPlaceholder}
        class="w-full px-4 py-3 bg-surface-light border border-border rounded-lg text-white placeholder-muted focus:outline-none focus:border-accent/50 focus:ring-1 focus:ring-accent/50 transition-all"
      />
    </div>
    
    <!-- Message -->
    <div>
      <label for="message" class="block text-sm font-medium text-zinc-300 mb-2">
        {t.message}
      </label>
      <textarea 
        id="message" 
        name="message" 
        required
        rows="4"
        placeholder={t.messagePlaceholder}
        class="w-full px-4 py-3 bg-surface-light border border-border rounded-lg text-white placeholder-muted focus:outline-none focus:border-accent/50 focus:ring-1 focus:ring-accent/50 transition-all resize-none"
      ></textarea>
    </div>
    
    <!-- Cloudflare Turnstile Widget -->
    <div 
      class="cf-turnstile" 
      data-sitekey={turnstileSiteKey}
      data-theme="dark"
      data-callback="onTurnstileSuccess"
    ></div>
    
    <!-- Submit Button -->
    <button 
      type="submit"
      id="submit-btn"
      disabled
      class="w-full px-6 py-4 bg-accent text-void font-semibold rounded-lg hover:bg-accent/90 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span id="btn-text">{t.send}</span>
      <svg id="btn-spinner" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </button>
    
    <!-- Status Messages -->
    <div id="form-status" class="hidden">
      <div id="success-message" class="hidden p-4 bg-accent/10 border border-accent/30 rounded-lg text-accent text-sm">
        {t.success}
      </div>
      <div id="error-message" class="hidden p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm">
        {t.error}
      </div>
    </div>
  </form>
</div>

<!-- Cloudflare Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script is:inline define:vars={{ sendingText: t.sending, sendText: t.send }}>
  // Enable submit button when Turnstile is complete
  window.onTurnstileSuccess = function() {
    document.getElementById('submit-btn').disabled = false;
  };
  
  // Handle form submission
  document.getElementById('contact-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const formStatus = document.getElementById('form-status');
    const successMsg = document.getElementById('success-message');
    const errorMsg = document.getElementById('error-message');
    
    // Show loading state
    submitBtn.disabled = true;
    btnText.textContent = sendingText;
    btnSpinner.classList.remove('hidden');
    formStatus.classList.add('hidden');
    successMsg.classList.add('hidden');
    errorMsg.classList.add('hidden');
    
    try {
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      formStatus.classList.remove('hidden');
      
      if (result.success) {
        successMsg.classList.remove('hidden');
        form.reset();
        // Reset Turnstile
        if (window.turnstile) {
          turnstile.reset();
        }
      } else {
        errorMsg.classList.remove('hidden');
      }
    } catch (error) {
      formStatus.classList.remove('hidden');
      errorMsg.classList.remove('hidden');
    }
    
    // Reset button
    btnText.textContent = sendText;
    btnSpinner.classList.add('hidden');
    submitBtn.disabled = true; // Will be re-enabled by Turnstile
  });
  
  // Check for success redirect
  if (window.location.search.includes('success=true')) {
    document.getElementById('form-status').classList.remove('hidden');
    document.getElementById('success-message').classList.remove('hidden');
    // Clean URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
</script>